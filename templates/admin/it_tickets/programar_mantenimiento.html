{% extends "admin/base_site.html" %}
{% load i18n %}

{% block title %}Programar pr√≥ximo mantenimiento | Admin{% endblock %}

{% block content %}
<div style="max-width:900px;">

    <h1 style="margin-bottom:8px;">
        üìÖ Programar fecha de pr√≥ximo mantenimiento
    </h1>
    <p style="color:#666; margin-bottom:24px;">
        Selecciona la fecha que se asignar√° como <strong>pr√≥ximo mantenimiento</strong>
        para los <strong>{{ equipos|length }} equipo(s)</strong> seleccionados.
    </p>

    <form method="post">
        {% csrf_token %}

        {# Re-enviar los IDs seleccionados para reconstruir el queryset #}
        {% for equipo in equipos %}
            <input type="hidden" name="{{ ACTION_CHECKBOX_NAME }}" value="{{ equipo.pk }}">
        {% endfor %}
        <input type="hidden" name="action" value="{{ action_name }}">
        <input type="hidden" name="select_across" value="0">

        {# Selector de fecha #}
        <div style="
            background:#fff;
            border:1px solid #ddd;
            border-radius:6px;
            padding:20px 24px;
            margin-bottom:20px;
            display:inline-block;
        ">
            <label for="fecha_proximo_mantenimiento"
                   style="display:block; font-weight:bold; font-size:14px; margin-bottom:8px; color:#333;">
                Nueva fecha de pr√≥ximo mantenimiento <span style="color:red;">*</span>
            </label>
            <input
                type="date"
                id="fecha_proximo_mantenimiento"
                name="fecha_proximo_mantenimiento"
                min="{{ fecha_minima }}"
                required
                style="
                    padding:8px 12px;
                    border:1px solid #ccc;
                    border-radius:4px;
                    font-size:15px;
                    outline:none;
                    min-width:180px;
                "
            >
            <p style="font-size:12px; color:#888; margin-top:6px;">
                Solo se permiten fechas de hoy en adelante.
            </p>
        </div>

        {# Lista de equipos afectados #}
        <div style="margin-bottom:24px;">
            <h2 style="font-size:15px; color:#444; margin-bottom:10px;">
                Equipos que ser√°n actualizados
            </h2>
            <div style="overflow-x:auto;">
                <table style="
                    width:100%;
                    border-collapse:collapse;
                    font-size:13px;
                    background:#fff;
                    border:1px solid #ddd;
                    border-radius:6px;
                    overflow:hidden;
                ">
                    <thead>
                        <tr style="background:#f8f9fa; border-bottom:2px solid #dee2e6;">
                            <th style="padding:10px 14px; text-align:left; color:#555; font-weight:600;">Serie</th>
                            <th style="padding:10px 14px; text-align:left; color:#555; font-weight:600;">Marca / Modelo</th>
                            <th style="padding:10px 14px; text-align:left; color:#555; font-weight:600;">Usuario</th>
                            <th style="padding:10px 14px; text-align:left; color:#555; font-weight:600;">Estado</th>
                            <th style="padding:10px 14px; text-align:left; color:#555; font-weight:600;">Pr√≥ximo mant. actual</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for equipo in equipos %}
                        <tr style="border-bottom:1px solid #f0f0f0;">
                            <td style="padding:9px 14px; font-family:monospace; font-size:12px; color:#555;">
                                {{ equipo.numero_serie }}
                            </td>
                            <td style="padding:9px 14px; font-weight:500;">
                                {{ equipo.marca }} {{ equipo.modelo }}
                            </td>
                            <td style="padding:9px 14px; color:#555;">
                                {{ equipo.usuario_nombre|default:"‚Äî" }}
                            </td>
                            <td style="padding:9px 14px;">
                                {% if equipo.estado == 'activo' %}
                                    <span style="background:#d4edda;color:#155724;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:600;">Activo</span>
                                {% elif equipo.estado == 'mantenimiento' %}
                                    <span style="background:#fff3cd;color:#856404;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:600;">Mantenimiento</span>
                                {% else %}
                                    <span style="background:#f8d7da;color:#721c24;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:600;">De Baja</span>
                                {% endif %}
                            </td>
                            <td style="padding:9px 14px; color:#555;">
                                {% if equipo.fecha_proximo_mantenimiento %}
                                    {% if equipo.mantenimiento_vencido %}
                                        <span style="color:red; font-weight:bold;">
                                            {{ equipo.fecha_proximo_mantenimiento|date:"d/m/Y" }} (VENCIDO)
                                        </span>
                                    {% else %}
                                        {{ equipo.fecha_proximo_mantenimiento|date:"d/m/Y" }}
                                    {% endif %}
                                {% else %}
                                    <span style="color:#aaa; font-style:italic;">Sin programar</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        {# Botones de acci√≥n #}
        <div style="display:flex; gap:12px; align-items:center;">
            <button
                type="submit"
                name="aplicar"
                value="1"
                style="
                    background:#007bff;
                    color:#fff;
                    border:none;
                    padding:10px 22px;
                    border-radius:4px;
                    font-size:14px;
                    font-weight:600;
                    cursor:pointer;
                "
                onmouseover="this.style.background='#0056b3'"
                onmouseout="this.style.background='#007bff'"
            >
                ‚úÖ Confirmar y guardar fecha
            </button>
            <a
                href="{% url 'admin:it_tickets_equipocomputo_changelist' %}"
                style="
                    color:#555;
                    text-decoration:none;
                    font-size:14px;
                    padding:10px 16px;
                    border:1px solid #ccc;
                    border-radius:4px;
                    background:#fff;
                "
            >
                ‚úñ Cancelar
            </a>
        </div>
    </form>

</div>
{% endblock %}
