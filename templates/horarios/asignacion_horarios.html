{% extends "base.html" %}

{% block title %}Asignacion de Horarios - {{ nombre_mes }} {{ anio }}{% endblock %}

{% block extra_css %}
<style>
    .schedule-grid {
        position: relative;
    }
    .sticky-col {
        position: sticky;
        left: 0;
        z-index: 10;
        background: white;
    }
    .sticky-col-header {
        position: sticky;
        left: 0;
        z-index: 20;
        background: #f9fafb;
    }
    .cell-btn {
        min-width: 44px;
        min-height: 32px;
        font-size: 0.65rem;
        cursor: pointer;
        transition: all 0.15s;
        border: 1px solid transparent;
    }
    .cell-btn:hover {
        border-color: #3b82f6;
        opacity: 0.85;
    }
    .cell-btn.predeterminado {
        opacity: 0.5;
        border-style: dashed;
        border-color: #9ca3af;
    }
    .weekend-col {
        background-color: #f3f4f6;
    }
    .dropdown-horario {
        min-width: 180px;
    }
</style>
{% endblock %}

{% block content %}
<div x-data="horarioGrid()" x-init="init()">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6 gap-4">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">
                <i class="fas fa-calendar-alt mr-2 text-blue-600"></i>
                Asignacion de Horarios
            </h1>
            <p class="text-gray-500 text-sm mt-1">Asigna horarios a los empleados por dia del mes</p>
        </div>

        <!-- Navegacion de mes -->
        <div class="flex items-center gap-2">
            <a href="?mes={{ mes_anterior }}&anio={{ anio_anterior }}{% if departamento_id %}&departamento={{ departamento_id }}{% endif %}"
               class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-2 rounded-md text-sm transition">
                <i class="fas fa-chevron-left"></i>
            </a>
            <span class="text-lg font-semibold text-gray-800 min-w-[160px] text-center">
                {{ nombre_mes }} {{ anio }}
            </span>
            <a href="?mes={{ mes_siguiente }}&anio={{ anio_siguiente }}{% if departamento_id %}&departamento={{ departamento_id }}{% endif %}"
               class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-2 rounded-md text-sm transition">
                <i class="fas fa-chevron-right"></i>
            </a>
        </div>
    </div>

    <!-- Filtros y acciones -->
    <div class="bg-white rounded-lg shadow-md p-4 mb-4">
        <div class="flex flex-col md:flex-row md:items-end gap-4">
            <!-- Filtro departamento -->
            <div class="flex-1">
                <label class="block text-gray-700 text-sm font-semibold mb-1">Departamento</label>
                <select onchange="window.location.href='?mes={{ mes }}&anio={{ anio }}&departamento='+this.value"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">Todos los departamentos</option>
                    {% for dep in departamentos %}
                    <option value="{{ dep.id }}" {% if departamento_id == dep.id|stringformat:"d" %}selected{% endif %}>
                        {{ dep.nombre }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Asignacion masiva -->
            <div class="flex-1">
                <label class="block text-gray-700 text-sm font-semibold mb-1">Asignar horario a todos</label>
                <div class="flex gap-2">
                    <select x-model="bulkTipoHorario"
                            class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Seleccionar horario...</option>
                        <template x-for="th in tiposHorario" :key="th.id">
                            <option :value="th.id" x-text="th.codigo + ' - ' + th.nombre"></option>
                        </template>
                    </select>
                    <button @click="asignarTodos()"
                            :disabled="!bulkTipoHorario"
                            class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white px-4 py-2 rounded-lg text-sm transition">
                        <i class="fas fa-check mr-1"></i>Aplicar
                    </button>
                </div>
            </div>

            <!-- Leyenda -->
            <div class="flex-1">
                <label class="block text-gray-700 text-sm font-semibold mb-1">Tipos de Horario</label>
                <div class="flex flex-wrap gap-1">
                    <template x-for="th in tiposHorario" :key="th.id">
                        <span class="inline-flex items-center px-2 py-1 rounded text-xs text-white font-medium"
                              :style="'background-color:' + th.color"
                              x-text="th.codigo + ' ' + th.hora_entrada + '-' + th.hora_salida">
                        </span>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- Indicador de carga -->
    <div x-show="loading" class="text-center py-4">
        <i class="fas fa-spinner fa-spin text-blue-600 text-2xl"></i>
        <p class="text-gray-500 text-sm mt-2">Guardando...</p>
    </div>

    <!-- Tabla tipo Excel -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="overflow-x-auto schedule-grid">
            <table class="w-full border-collapse">
                <thead>
                    <tr class="bg-gray-50">
                        <th class="sticky-col-header border-b border-r border-gray-200 px-3 py-2 text-left text-xs font-semibold text-gray-600 min-w-[200px]">
                            Empleado
                        </th>
                        {% for dia in dias %}
                        <th class="border-b border-r border-gray-200 px-1 py-2 text-center text-xs font-semibold {% if dia.es_fin_semana %}bg-gray-100 text-gray-400{% else %}text-gray-600{% endif %}"
                            style="min-width: 44px;">
                            <div>{{ dia.numero }}</div>
                            <div class="text-[10px] font-normal">{{ dia.nombre_corto }}</div>
                        </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for emp in empleados_data %}
                    <tr class="hover:bg-blue-50 transition-colors">
                        <td class="sticky-col border-b border-r border-gray-200 px-3 py-1">
                            <div class="text-xs font-semibold text-gray-800">{{ emp.codigo }}</div>
                            <div class="text-[10px] text-gray-500 truncate max-w-[180px]">{{ emp.nombre }}</div>
                        </td>
                        {% for dia in dias %}
                        <td class="border-b border-r border-gray-100 p-0 {% if dia.es_fin_semana %}weekend-col{% endif %}"
                            x-data="{ showMenu: false }">
                            <div class="relative">
                                {% with emp_id=emp.id fecha=dia.fecha %}
                                <button
                                    @click="showMenu = !showMenu"
                                    @click.outside="showMenu = false"
                                    class="cell-btn w-full flex items-center justify-center rounded text-xs font-medium"
                                    :class="getCellClass({{ emp.id }}, '{{ dia.fecha }}')"
                                    :style="getCellStyle({{ emp.id }}, '{{ dia.fecha }}')">
                                    <span x-text="getCellText({{ emp.id }}, '{{ dia.fecha }}')"></span>
                                </button>
                                {% endwith %}

                                <!-- Dropdown menu -->
                                <div x-show="showMenu"
                                     x-transition
                                     class="absolute z-30 top-full left-0 mt-1 dropdown-horario bg-white rounded-lg shadow-lg border border-gray-200 py-1">
                                    <button @click="asignarHorario({{ emp.id }}, '{{ dia.fecha }}', 0); showMenu = false"
                                            class="w-full text-left px-3 py-1.5 text-xs text-gray-500 hover:bg-gray-100">
                                        <i class="fas fa-times mr-1"></i> Sin horario
                                    </button>
                                    <template x-for="th in tiposHorario" :key="th.id">
                                        <button @click="asignarHorario({{ emp.id }}, '{{ dia.fecha }}', th.id); showMenu = false"
                                                class="w-full text-left px-3 py-1.5 text-xs hover:bg-gray-100 flex items-center gap-2">
                                            <span class="w-3 h-3 rounded-sm inline-block" :style="'background-color:' + th.color"></span>
                                            <span x-text="th.codigo + ' - ' + th.nombre"></span>
                                        </button>
                                    </template>
                                </div>
                            </div>
                        </td>
                        {% endfor %}
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="{{ dias|length|add:1 }}" class="text-center py-8 text-gray-500">
                            <i class="fas fa-users text-4xl mb-2"></i>
                            <p>No se encontraron empleados</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Mensaje de estado -->
    <div x-show="mensaje" x-transition
         class="fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg text-sm z-50">
        <i class="fas fa-check mr-1"></i>
        <span x-text="mensaje"></span>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function horarioGrid() {
    return {
        tiposHorario: {{ tipos_horario|safe }},
        asignaciones: {},
        bulkTipoHorario: '',
        loading: false,
        mensaje: '',
        csrfToken: '{{ csrf_token }}',

        init() {
            // Cargar asignaciones iniciales desde el contexto Django
            const empleadosData = {{ empleados_data_json|safe }};
            empleadosData.forEach(emp => {
                Object.entries(emp.asignaciones).forEach(([fecha, data]) => {
                    const key = emp.id + '_' + fecha;
                    this.asignaciones[key] = data;
                });
            });

            // Formatear horas en tiposHorario
            this.tiposHorario = this.tiposHorario.map(th => ({
                ...th,
                hora_entrada: this.formatTime(th.hora_entrada),
                hora_salida: this.formatTime(th.hora_salida),
            }));
        },

        formatTime(t) {
            if (!t) return '';
            // Si es string tipo "08:00:00", cortar a "08:00"
            return String(t).substring(0, 5);
        },

        getCellText(empId, fecha) {
            const key = empId + '_' + fecha;
            const a = this.asignaciones[key];
            return a ? a.codigo : '';
        },

        getCellStyle(empId, fecha) {
            const key = empId + '_' + fecha;
            const a = this.asignaciones[key];
            if (a && a.color) {
                return 'background-color:' + a.color + '; color: white;';
            }
            return '';
        },

        getCellClass(empId, fecha) {
            const key = empId + '_' + fecha;
            const a = this.asignaciones[key];
            if (a && a.es_predeterminado) {
                return 'predeterminado';
            }
            return '';
        },

        async asignarHorario(empId, fecha, tipoHorarioId) {
            this.loading = true;
            try {
                const response = await fetch('/api/horarios/asignaciones/asignar/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.csrfToken,
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        empleado: empId,
                        fecha: fecha,
                        tipo_horario: tipoHorarioId,
                    })
                });

                const data = await response.json();

                if (data.success) {
                    const key = empId + '_' + fecha;
                    if (tipoHorarioId && tipoHorarioId !== 0) {
                        const th = this.tiposHorario.find(t => t.id === tipoHorarioId);
                        if (th) {
                            this.asignaciones[key] = {
                                tipo_horario_id: th.id,
                                codigo: th.codigo,
                                color: th.color,
                                nombre: th.nombre,
                            };
                        }
                    } else {
                        delete this.asignaciones[key];
                    }
                    this.showMensaje('Horario actualizado');
                }
            } catch (error) {
                console.error('Error:', error);
                this.showMensaje('Error al guardar');
            }
            this.loading = false;
        },

        async asignarTodos() {
            if (!this.bulkTipoHorario) return;
            if (!confirm('Esto asignara el horario seleccionado a TODOS los empleados visibles en todos los dias laborales del mes. Continuar?')) return;

            this.loading = true;
            const tipoId = parseInt(this.bulkTipoHorario);
            const empleadosData = {{ empleados_data_json|safe }};
            const empIds = empleadosData.map(e => e.id);
            const fechas = [];

            // Solo dias laborales (no fines de semana)
            const diasData = {{ dias_json|safe }};
            diasData.forEach(d => {
                if (!d.es_fin_semana) {
                    fechas.push(d.fecha);
                }
            });

            try {
                const response = await fetch('/api/horarios/asignaciones/bulk/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.csrfToken,
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        tipo_horario: tipoId,
                        empleados: empIds,
                        fechas: fechas,
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Recargar la pagina para refrescar datos
                    this.showMensaje(`${data.total} asignaciones realizadas`);
                    setTimeout(() => location.reload(), 1000);
                }
            } catch (error) {
                console.error('Error:', error);
                this.showMensaje('Error al guardar');
            }
            this.loading = false;
        },

        showMensaje(msg) {
            this.mensaje = msg;
            setTimeout(() => { this.mensaje = ''; }, 2500);
        },
    }
}
</script>
{% endblock %}
