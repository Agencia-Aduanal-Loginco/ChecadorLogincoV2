{% extends "base.html" %}

{% block title %}Tickets de Soporte IT{% endblock %}

{% block content %}
<div x-data="listaTickets()" x-init="init()">

    <!-- Encabezado -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 gap-4">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">
                <i class="fas fa-list-alt mr-2 text-blue-600"></i>
                {% if es_it %}Tickets de Soporte{% else %}Mis Tickets{% endif %}
            </h1>
            <p class="text-gray-500 text-sm mt-1">
                {{ tickets|length }} ticket{{ tickets|length|pluralize }} encontrado{{ tickets|length|pluralize }}
            </p>
        </div>
        <button @click="modalNuevo = true"
                class="inline-flex items-center bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition">
            <i class="fas fa-plus mr-2"></i>Nuevo Ticket
        </button>
    </div>

    <!-- Barra de filtros -->
    <div class="bg-white rounded-lg shadow p-4 mb-6">
        <form method="GET" action="{% url 'it_tickets:lista_tickets_it' %}" class="flex flex-wrap gap-3 items-end">

            <!-- Busqueda -->
            <div class="flex-1 min-w-48">
                <label for="q" class="block text-xs font-medium text-gray-500 mb-1">
                    <i class="fas fa-search mr-1"></i>Buscar
                </label>
                <input type="text" name="q" id="q" value="{{ buscar }}"
                       placeholder="Folio, titulo, descripcion..."
                       class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
            </div>

            <!-- Filtro Estado -->
            <div class="min-w-36">
                <label for="estado" class="block text-xs font-medium text-gray-500 mb-1">Estado</label>
                <select name="estado" id="estado"
                        class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    <option value="">Todos los estados</option>
                    {% for valor, etiqueta in estados %}
                    <option value="{{ valor }}" {% if filtro_estado == valor %}selected{% endif %}>{{ etiqueta }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Filtro Prioridad -->
            <div class="min-w-36">
                <label for="prioridad" class="block text-xs font-medium text-gray-500 mb-1">Prioridad</label>
                <select name="prioridad" id="prioridad"
                        class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    <option value="">Todas</option>
                    <option value="critica" {% if filtro_prioridad == 'critica' %}selected{% endif %}>Critica</option>
                    <option value="alta" {% if filtro_prioridad == 'alta' %}selected{% endif %}>Alta</option>
                    <option value="media" {% if filtro_prioridad == 'media' %}selected{% endif %}>Media</option>
                    <option value="baja" {% if filtro_prioridad == 'baja' %}selected{% endif %}>Baja</option>
                </select>
            </div>

            <!-- Filtro Categoria -->
            <div class="min-w-36">
                <label for="categoria" class="block text-xs font-medium text-gray-500 mb-1">Categoria</label>
                <select name="categoria" id="categoria"
                        class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    <option value="">Todas</option>
                    <option value="hardware" {% if filtro_categoria == 'hardware' %}selected{% endif %}>Hardware</option>
                    <option value="software" {% if filtro_categoria == 'software' %}selected{% endif %}>Software</option>
                    <option value="red" {% if filtro_categoria == 'red' %}selected{% endif %}>Red / Conectividad</option>
                    <option value="otro" {% if filtro_categoria == 'otro' %}selected{% endif %}>Otro</option>
                </select>
            </div>

            <!-- Botones de accion -->
            <div class="flex gap-2">
                <button type="submit"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition">
                    <i class="fas fa-filter mr-1"></i>Filtrar
                </button>
                {% if buscar or filtro_estado or filtro_prioridad or filtro_categoria %}
                <a href="{% url 'it_tickets:lista_tickets_it' %}"
                   class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-md text-sm font-medium transition">
                    <i class="fas fa-times mr-1"></i>Limpiar
                </a>
                {% endif %}
            </div>
        </form>
    </div>

    <!-- Tabla de tickets -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        {% if tickets %}
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Folio</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Titulo</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoria</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prioridad</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                        {% if es_it %}
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Empleado</th>
                        {% endif %}
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Accion</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-100">
                    {% for ticket in tickets %}
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-4 py-3">
                            <a href="{% url 'it_tickets:detalle_ticket_it' ticket.pk %}"
                               class="text-blue-600 hover:underline font-mono text-sm font-medium">
                                {{ ticket.folio }}
                            </a>
                        </td>
                        <td class="px-4 py-3 max-w-xs">
                            <p class="text-sm text-gray-900 truncate font-medium">{{ ticket.titulo }}</p>
                            {% if ticket.equipo %}
                            <p class="text-xs text-gray-400 mt-0.5">
                                <i class="fas fa-laptop mr-1"></i>{{ ticket.equipo.marca }} {{ ticket.equipo.modelo }}
                            </p>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3">
                            <span class="text-sm text-gray-600">
                                {% if ticket.categoria == 'hardware' %}<i class="fas fa-microchip mr-1 text-gray-400"></i>
                                {% elif ticket.categoria == 'software' %}<i class="fas fa-code mr-1 text-gray-400"></i>
                                {% elif ticket.categoria == 'red' %}<i class="fas fa-network-wired mr-1 text-gray-400"></i>
                                {% else %}<i class="fas fa-question-circle mr-1 text-gray-400"></i>
                                {% endif %}
                                {{ ticket.get_categoria_display }}
                            </span>
                        </td>
                        <td class="px-4 py-3">
                            {% if ticket.prioridad %}
                                {% include "it_tickets/partials/badge_prioridad.html" with prioridad=ticket.prioridad label=ticket.get_prioridad_display %}
                            {% else %}
                                <span class="text-xs text-gray-400 italic">Sin asignar</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3">
                            {% include "it_tickets/partials/badge_estado.html" with estado=ticket.estado label=ticket.get_estado_display %}
                        </td>
                        {% if es_it %}
                        <td class="px-4 py-3 text-sm text-gray-600">
                            {{ ticket.empleado.user.get_full_name|default:ticket.empleado.user.username }}
                        </td>
                        {% endif %}
                        <td class="px-4 py-3 text-sm text-gray-500 whitespace-nowrap">
                            {{ ticket.fecha_creacion|date:"d/m/Y" }}
                            <br>
                            <span class="text-xs text-gray-400">{{ ticket.fecha_creacion|date:"H:i" }}</span>
                        </td>
                        <td class="px-4 py-3 text-right">
                            <a href="{% url 'it_tickets:detalle_ticket_it' ticket.pk %}"
                               class="inline-flex items-center text-sm text-blue-600 hover:text-blue-800 font-medium">
                                Ver <i class="fas fa-chevron-right ml-1 text-xs"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="px-6 py-16 text-center text-gray-400">
            <i class="fas fa-search text-5xl mb-4"></i>
            <p class="text-lg font-medium text-gray-600">No se encontraron tickets</p>
            <p class="text-sm mt-1">
                {% if buscar or filtro_estado or filtro_prioridad or filtro_categoria %}
                    Intenta ajustar los filtros de busqueda
                {% else %}
                    Crea el primer ticket de soporte
                {% endif %}
            </p>
            <div class="mt-5 flex gap-3 justify-center">
                {% if buscar or filtro_estado or filtro_prioridad or filtro_categoria %}
                <a href="{% url 'it_tickets:lista_tickets_it' %}"
                   class="inline-flex items-center bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-md text-sm font-medium transition">
                    <i class="fas fa-times mr-2"></i>Limpiar filtros
                </a>
                {% endif %}
                <button @click="modalNuevo = true"
                        class="inline-flex items-center bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition">
                    <i class="fas fa-plus mr-2"></i>Nuevo Ticket
                </button>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- =======================================================================
         Modal: Nuevo Ticket
         ======================================================================= -->
    <div x-show="modalNuevo"
         x-cloak
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-gray-600 bg-opacity-50 z-50 flex items-center justify-center p-4"
         @keydown.escape.window="cerrarModal()">

        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             @click.outside="cerrarModal()">

            <!-- Header del modal -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-plus-circle mr-2 text-blue-500"></i>Nuevo Ticket de Soporte
                </h3>
                <button @click="cerrarModal()" class="text-gray-400 hover:text-gray-600 transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- Formulario -->
            <form id="form-nuevo-ticket" @submit.prevent="submitTicket()">
                <div class="px-6 py-5 space-y-4">

                    <!-- Titulo -->
                    <div>
                        <label for="titulo" class="block text-sm font-medium text-gray-700 mb-1">
                            Titulo del problema <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="titulo" name="titulo" x-model="form.titulo" required
                               maxlength="200"
                               placeholder="Describe brevemente el problema..."
                               class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                               :class="{ 'border-red-400': errores.titulo }">
                        <p x-show="errores.titulo" x-text="errores.titulo" class="text-xs text-red-500 mt-1"></p>
                    </div>

                    <!-- Descripcion -->
                    <div>
                        <label for="descripcion" class="block text-sm font-medium text-gray-700 mb-1">
                            Descripcion detallada <span class="text-red-500">*</span>
                        </label>
                        <textarea id="descripcion" name="descripcion" x-model="form.descripcion" required
                                  rows="4"
                                  placeholder="Explica con detalle el problema: que ocurre, cuando ocurre, que intentaste hacer..."
                                  class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none resize-none"
                                  :class="{ 'border-red-400': errores.descripcion }"></textarea>
                        <p x-show="errores.descripcion" x-text="errores.descripcion" class="text-xs text-red-500 mt-1"></p>
                    </div>

                    <!-- Categoria -->
                    <div>
                        <label for="categoria" class="block text-sm font-medium text-gray-700 mb-1">
                            Categoria <span class="text-red-500">*</span>
                        </label>
                        <select id="categoria" name="categoria" x-model="form.categoria" required
                                class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                                :class="{ 'border-red-400': errores.categoria }">
                            <option value="">Selecciona una categoria...</option>
                            <option value="hardware">Hardware (equipo fisico)</option>
                            <option value="software">Software (programas, apps)</option>
                            <option value="red">Red / Conectividad (internet, red)</option>
                            <option value="otro">Otro</option>
                        </select>
                        <p x-show="errores.categoria" x-text="errores.categoria" class="text-xs text-red-500 mt-1"></p>
                    </div>

                    <!-- Equipo (texto libre, opcional) -->
                    <div>
                        <label for="equipo_desc" class="block text-sm font-medium text-gray-700 mb-1">
                            Equipo relacionado <span class="text-gray-400 font-normal">(opcional)</span>
                        </label>
                        <input type="text" id="equipo_desc" name="equipo_desc" x-model="form.equipo_desc"
                               placeholder="Nombre del equipo, numero de serie o descripcion..."
                               class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>

                    <!-- Mensaje de error general -->
                    <div x-show="errorGeneral"
                         class="bg-red-50 border border-red-200 text-red-700 text-sm px-4 py-3 rounded-md">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        <span x-text="errorGeneral"></span>
                    </div>

                    <!-- Mensaje de exito -->
                    <div x-show="exito"
                         class="bg-green-50 border border-green-200 text-green-700 text-sm px-4 py-3 rounded-md">
                        <i class="fas fa-check-circle mr-2"></i>
                        Tu ticket fue creado correctamente. Redirigiendo...
                    </div>

                </div>

                <!-- Footer del modal -->
                <div class="px-6 py-4 bg-gray-50 rounded-b-lg flex justify-end gap-3">
                    <button type="button" @click="cerrarModal()"
                            class="bg-white hover:bg-gray-100 text-gray-700 border border-gray-300 px-4 py-2 rounded-md text-sm font-medium transition">
                        Cancelar
                    </button>
                    <button type="submit"
                            :disabled="cargando"
                            class="bg-blue-600 hover:bg-blue-700 disabled:bg-blue-400 text-white px-5 py-2 rounded-md text-sm font-medium transition inline-flex items-center gap-2">
                        <svg x-show="cargando" class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                        </svg>
                        <span x-text="cargando ? 'Enviando...' : 'Crear Ticket'"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
function listaTickets() {
    return {
        modalNuevo: false,
        cargando: false,
        exito: false,
        errorGeneral: '',
        errores: {},
        form: {
            titulo: '',
            descripcion: '',
            categoria: '',
            equipo_desc: '',
        },

        init() {
            // Abrir modal si viene ?nuevo=1 en la URL
            const params = new URLSearchParams(window.location.search);
            if (params.get('nuevo') === '1') {
                this.modalNuevo = true;
            }
        },

        cerrarModal() {
            if (this.exito) return; // Esperar redireccion
            this.modalNuevo = false;
            this.resetForm();
        },

        resetForm() {
            this.form = { titulo: '', descripcion: '', categoria: '', equipo_desc: '' };
            this.errores = {};
            this.errorGeneral = '';
            this.exito = false;
        },

        async submitTicket() {
            this.cargando = true;
            this.errores = {};
            this.errorGeneral = '';

            // Obtener token CSRF del cookie
            const csrfToken = this.getCookie('csrftoken');

            const payload = {
                titulo: this.form.titulo,
                descripcion: this.form.descripcion,
                categoria: this.form.categoria,
            };

            try {
                const resp = await fetch('/api/it/tickets/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                    },
                    body: JSON.stringify(payload),
                });

                const data = await resp.json();

                if (resp.ok) {
                    this.exito = true;
                    // Redirigir al detalle del ticket recien creado
                    setTimeout(() => {
                        window.location.href = '/it/tickets/' + data.id + '/';
                    }, 1200);
                } else {
                    // Mapear errores del serializer
                    if (typeof data === 'object') {
                        if (data.titulo) this.errores.titulo = Array.isArray(data.titulo) ? data.titulo[0] : data.titulo;
                        if (data.descripcion) this.errores.descripcion = Array.isArray(data.descripcion) ? data.descripcion[0] : data.descripcion;
                        if (data.categoria) this.errores.categoria = Array.isArray(data.categoria) ? data.categoria[0] : data.categoria;
                        if (data.detail || data.non_field_errors) {
                            this.errorGeneral = data.detail || (Array.isArray(data.non_field_errors) ? data.non_field_errors[0] : data.non_field_errors);
                        }
                    } else {
                        this.errorGeneral = 'Ocurrio un error al crear el ticket. Intenta de nuevo.';
                    }
                }
            } catch (e) {
                this.errorGeneral = 'Error de conexion. Verifica tu red e intenta de nuevo.';
            } finally {
                this.cargando = false;
            }
        },

        getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        },
    };
}
</script>
{% endblock %}
