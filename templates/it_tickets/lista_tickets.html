{% extends "base.html" %}

{% block title %}Tickets de Soporte IT{% endblock %}

{% block content %}
<div x-data="listaTickets()" x-init="init()">

    <!-- Encabezado -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 gap-4">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">
                <i class="fas fa-list-alt mr-2 text-blue-600"></i>
                {% if es_it %}Tickets de Soporte{% else %}Mis Tickets{% endif %}
            </h1>
            <p class="text-gray-500 text-sm mt-1">
                {{ tickets|length }} ticket{{ tickets|length|pluralize }} encontrado{{ tickets|length|pluralize }}
            </p>
        </div>
        <button @click="modalNuevo = true"
                class="inline-flex items-center bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition">
            <i class="fas fa-plus mr-2"></i>Nuevo Ticket
        </button>
    </div>

    <!-- Barra de filtros -->
    <div class="bg-white rounded-lg shadow p-4 mb-6">
        <form method="GET" action="{% url 'it_tickets:lista_tickets_it' %}" class="flex flex-wrap gap-3 items-end">

            <!-- Busqueda -->
            <div class="flex-1 min-w-48">
                <label for="q" class="block text-xs font-medium text-gray-500 mb-1">
                    <i class="fas fa-search mr-1"></i>Buscar
                </label>
                <input type="text" name="q" id="q" value="{{ buscar }}"
                       placeholder="Folio, titulo, descripcion..."
                       class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
            </div>

            <!-- Filtro Estado -->
            <div class="min-w-36">
                <label for="estado" class="block text-xs font-medium text-gray-500 mb-1">Estado</label>
                <select name="estado" id="estado"
                        class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    <option value="">Todos los estados</option>
                    {% for valor, etiqueta in estados %}
                    <option value="{{ valor }}" {% if filtro_estado == valor %}selected{% endif %}>{{ etiqueta }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Filtro Prioridad -->
            <div class="min-w-36">
                <label for="prioridad" class="block text-xs font-medium text-gray-500 mb-1">Prioridad</label>
                <select name="prioridad" id="prioridad"
                        class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    <option value="">Todas</option>
                    <option value="critica" {% if filtro_prioridad == 'critica' %}selected{% endif %}>Critica</option>
                    <option value="alta" {% if filtro_prioridad == 'alta' %}selected{% endif %}>Alta</option>
                    <option value="media" {% if filtro_prioridad == 'media' %}selected{% endif %}>Media</option>
                    <option value="baja" {% if filtro_prioridad == 'baja' %}selected{% endif %}>Baja</option>
                </select>
            </div>

            <!-- Filtro Categoria -->
            <div class="min-w-36">
                <label for="categoria" class="block text-xs font-medium text-gray-500 mb-1">Categoria</label>
                <select name="categoria" id="categoria"
                        class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    <option value="">Todas</option>
                    <option value="hardware" {% if filtro_categoria == 'hardware' %}selected{% endif %}>Hardware</option>
                    <option value="software" {% if filtro_categoria == 'software' %}selected{% endif %}>Software</option>
                    <option value="red" {% if filtro_categoria == 'red' %}selected{% endif %}>Red / Conectividad</option>
                    <option value="otro" {% if filtro_categoria == 'otro' %}selected{% endif %}>Otro</option>
                </select>
            </div>

            <!-- Botones de accion -->
            <div class="flex gap-2">
                <button type="submit"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition">
                    <i class="fas fa-filter mr-1"></i>Filtrar
                </button>
                {% if buscar or filtro_estado or filtro_prioridad or filtro_categoria %}
                <a href="{% url 'it_tickets:lista_tickets_it' %}"
                   class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-md text-sm font-medium transition">
                    <i class="fas fa-times mr-1"></i>Limpiar
                </a>
                {% endif %}
            </div>
        </form>
    </div>

    <!-- Tabla de tickets -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        {% if tickets %}
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Folio</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Titulo</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoria</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prioridad</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                        {% if es_it %}
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Empleado</th>
                        {% endif %}
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Accion</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-100">
                    {% for ticket in tickets %}
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-4 py-3">
                            <a href="{% url 'it_tickets:detalle_ticket_it' ticket.pk %}"
                               class="text-blue-600 hover:underline font-mono text-sm font-medium">
                                {{ ticket.folio }}
                            </a>
                        </td>
                        <td class="px-4 py-3 max-w-xs">
                            <p class="text-sm text-gray-900 truncate font-medium">{{ ticket.titulo }}</p>
                            {% if ticket.equipo %}
                            <p class="text-xs text-gray-400 mt-0.5">
                                <i class="fas fa-laptop mr-1"></i>{{ ticket.equipo.marca }} {{ ticket.equipo.modelo }}
                            </p>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3">
                            <span class="text-sm text-gray-600">
                                {% if ticket.categoria == 'hardware' %}<i class="fas fa-microchip mr-1 text-gray-400"></i>
                                {% elif ticket.categoria == 'software' %}<i class="fas fa-code mr-1 text-gray-400"></i>
                                {% elif ticket.categoria == 'red' %}<i class="fas fa-network-wired mr-1 text-gray-400"></i>
                                {% else %}<i class="fas fa-question-circle mr-1 text-gray-400"></i>
                                {% endif %}
                                {{ ticket.get_categoria_display }}
                            </span>
                        </td>
                        <td class="px-4 py-3">
                            {% if ticket.prioridad %}
                                {% include "it_tickets/partials/badge_prioridad.html" with prioridad=ticket.prioridad label=ticket.get_prioridad_display %}
                            {% else %}
                                <span class="text-xs text-gray-400 italic">Sin asignar</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3">
                            {% include "it_tickets/partials/badge_estado.html" with estado=ticket.estado label=ticket.get_estado_display %}
                        </td>
                        {% if es_it %}
                        <td class="px-4 py-3 text-sm text-gray-600">
                            {{ ticket.empleado.user.get_full_name|default:ticket.empleado.user.username }}
                        </td>
                        {% endif %}
                        <td class="px-4 py-3 text-sm text-gray-500 whitespace-nowrap">
                            {{ ticket.fecha_creacion|date:"d/m/Y" }}
                            <br>
                            <span class="text-xs text-gray-400">{{ ticket.fecha_creacion|date:"H:i" }}</span>
                        </td>
                        <td class="px-4 py-3 text-right">
                            <a href="{% url 'it_tickets:detalle_ticket_it' ticket.pk %}"
                               class="inline-flex items-center text-sm text-blue-600 hover:text-blue-800 font-medium">
                                Ver <i class="fas fa-chevron-right ml-1 text-xs"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="px-6 py-16 text-center text-gray-400">
            <i class="fas fa-search text-5xl mb-4"></i>
            <p class="text-lg font-medium text-gray-600">No se encontraron tickets</p>
            <p class="text-sm mt-1">
                {% if buscar or filtro_estado or filtro_prioridad or filtro_categoria %}
                    Intenta ajustar los filtros de busqueda
                {% else %}
                    Crea el primer ticket de soporte
                {% endif %}
            </p>
            <div class="mt-5 flex gap-3 justify-center">
                {% if buscar or filtro_estado or filtro_prioridad or filtro_categoria %}
                <a href="{% url 'it_tickets:lista_tickets_it' %}"
                   class="inline-flex items-center bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-md text-sm font-medium transition">
                    <i class="fas fa-times mr-2"></i>Limpiar filtros
                </a>
                {% endif %}
                <button @click="modalNuevo = true"
                        class="inline-flex items-center bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition">
                    <i class="fas fa-plus mr-2"></i>Nuevo Ticket
                </button>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- =======================================================================
         Modal: Nuevo Ticket (formulario dinámico por categoría)
         ======================================================================= -->
    <div x-show="modalNuevo"
         x-cloak
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-gray-600 bg-opacity-50 z-50 flex items-center justify-center p-4"
         @keydown.escape.window="cerrarModal()"
         role="dialog" aria-modal="true" aria-labelledby="modal-titulo">

        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] flex flex-col"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             @click.outside="cerrarModal()">

            <!-- Header -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 flex-shrink-0">
                <h3 id="modal-titulo" class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-headset mr-2 text-blue-500"></i>Nuevo Ticket de Soporte
                </h3>
                <button @click="cerrarModal()" aria-label="Cerrar modal"
                        class="text-gray-400 hover:text-gray-600 transition p-1 rounded">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>

            <!-- Formulario (scrollable) -->
            <form id="form-nuevo-ticket" @submit.prevent="submitTicket()" class="flex flex-col flex-1 overflow-hidden">
                <div class="px-6 py-5 space-y-5 overflow-y-auto flex-1">

                    <!-- ── PASO 1: Categoría ── -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ¿Qué tipo de problema tienes? <span class="text-red-500">*</span>
                        </label>
                        <div class="grid grid-cols-2 gap-2">
                            <template x-for="cat in categorias" :key="cat.valor">
                                <button type="button"
                                        @click="seleccionarCategoria(cat.valor)"
                                        :class="form.categoria === cat.valor
                                            ? 'border-blue-500 bg-blue-50 text-blue-700 ring-2 ring-blue-500'
                                            : 'border-gray-200 bg-white text-gray-700 hover:border-blue-300 hover:bg-blue-50'"
                                        class="flex items-center gap-2 px-3 py-3 rounded-lg border-2 text-sm font-medium transition text-left">
                                    <i :class="cat.icono" class="text-base w-5 text-center flex-shrink-0"></i>
                                    <span x-text="cat.label"></span>
                                </button>
                            </template>
                        </div>
                        <p x-show="errores.categoria" x-text="errores.categoria"
                           class="text-xs text-red-500 mt-1" role="alert"></p>
                    </div>

                    <!-- ── PASO 2a: Hardware → selector de equipo ── -->
                    <div x-show="form.categoria === 'hardware'"
                         x-transition:enter="transition ease-out duration-150"
                         x-transition:enter-start="opacity-0 -translate-y-1"
                         x-transition:enter-end="opacity-100 translate-y-0">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-microchip mr-1 text-gray-400"></i>
                            ¿Cuál equipo tiene el problema? <span class="text-red-500">*</span>
                        </label>
                        <div class="space-y-2">
                            <!-- Computadoras del inventario -->
                            <template x-for="eq in equiposEmpleado" :key="eq.id">
                                <label :for="'eq-' + eq.id"
                                       :class="form.subcategoria === 'eq_' + eq.id
                                            ? 'border-blue-500 bg-blue-50 ring-1 ring-blue-500'
                                            : 'border-gray-200 hover:border-blue-300'"
                                       class="flex items-center gap-3 px-4 py-3 rounded-lg border-2 cursor-pointer transition">
                                    <input type="radio" :id="'eq-' + eq.id"
                                           :value="'eq_' + eq.id"
                                           x-model="form.subcategoria"
                                           @change="form.equipoId = eq.id"
                                           class="text-blue-600 focus:ring-blue-500">
                                    <i :class="eq.tipo === 'laptop' ? 'fas fa-laptop' : 'fas fa-desktop'"
                                       class="text-gray-400 w-4"></i>
                                    <span class="text-sm">
                                        <span class="font-medium" x-text="eq.marca + ' ' + eq.modelo"></span>
                                        <span class="text-gray-400 text-xs block" x-text="'S/N: ' + eq.numero_serie"></span>
                                    </span>
                                </label>
                            </template>
                            <!-- Teléfono (si tiene) -->
                            <template x-if="equiposEmpleado.some(e => e.tiene_telefono)">
                                <label for="eq-telefono"
                                       :class="form.subcategoria === 'telefono'
                                            ? 'border-blue-500 bg-blue-50 ring-1 ring-blue-500'
                                            : 'border-gray-200 hover:border-blue-300'"
                                       class="flex items-center gap-3 px-4 py-3 rounded-lg border-2 cursor-pointer transition">
                                    <input type="radio" id="eq-telefono"
                                           value="telefono"
                                           x-model="form.subcategoria"
                                           @change="form.equipoId = null"
                                           class="text-blue-600 focus:ring-blue-500">
                                    <i class="fas fa-phone text-gray-400 w-4"></i>
                                    <span class="text-sm font-medium">Mi teléfono IP</span>
                                </label>
                            </template>
                            <!-- Sin equipos en inventario -->
                            <template x-if="equiposEmpleado.length === 0">
                                <div class="text-sm text-gray-500 bg-gray-50 px-4 py-3 rounded-lg border border-gray-200">
                                    <i class="fas fa-info-circle mr-2 text-blue-400"></i>
                                    No tienes equipos registrados en el inventario. El área de IT los asignará.
                                </div>
                            </template>
                        </div>
                        <p x-show="errores.subcategoria" x-text="errores.subcategoria"
                           class="text-xs text-red-500 mt-1" role="alert"></p>
                    </div>

                    <!-- ── PASO 2b: Software → tipo de software ── -->
                    <div x-show="form.categoria === 'software'"
                         x-transition:enter="transition ease-out duration-150"
                         x-transition:enter-start="opacity-0 -translate-y-1"
                         x-transition:enter-end="opacity-100 translate-y-0">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-code mr-1 text-gray-400"></i>
                            ¿En qué programa o sistema? <span class="text-red-500">*</span>
                        </label>
                        <div class="grid grid-cols-2 gap-2">
                            <template x-for="sub in subcategoriasSoftware" :key="sub.valor">
                                <label :for="'sw-' + sub.valor"
                                       :class="form.subcategoria === sub.valor
                                            ? 'border-blue-500 bg-blue-50 ring-1 ring-blue-500'
                                            : 'border-gray-200 hover:border-blue-300'"
                                       class="flex items-center gap-2 px-3 py-3 rounded-lg border-2 cursor-pointer transition text-sm">
                                    <input type="radio" :id="'sw-' + sub.valor"
                                           :value="sub.valor"
                                           x-model="form.subcategoria"
                                           class="text-blue-600 focus:ring-blue-500">
                                    <i :class="sub.icono" class="text-gray-400 w-4"></i>
                                    <span x-text="sub.label" class="font-medium"></span>
                                </label>
                            </template>
                        </div>
                    </div>

                    <!-- ── PASO 2c: Red / Conectividad → tipo de problema ── -->
                    <div x-show="form.categoria === 'red'"
                         x-transition:enter="transition ease-out duration-150"
                         x-transition:enter-start="opacity-0 -translate-y-1"
                         x-transition:enter-end="opacity-100 translate-y-0">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-network-wired mr-1 text-gray-400"></i>
                            ¿Cuál es el problema de red? <span class="text-red-500">*</span>
                        </label>
                        <div class="space-y-2">
                            <template x-for="sub in subcategoriasRed" :key="sub.valor">
                                <label :for="'red-' + sub.valor"
                                       :class="form.subcategoria === sub.valor
                                            ? 'border-blue-500 bg-blue-50 ring-1 ring-blue-500'
                                            : 'border-gray-200 hover:border-blue-300'"
                                       class="flex items-center gap-3 px-4 py-3 rounded-lg border-2 cursor-pointer transition text-sm">
                                    <input type="radio" :id="'red-' + sub.valor"
                                           :value="sub.valor"
                                           x-model="form.subcategoria"
                                           class="text-blue-600 focus:ring-blue-500">
                                    <i :class="sub.icono" class="text-gray-400 w-4"></i>
                                    <span x-text="sub.label" class="font-medium"></span>
                                </label>
                            </template>
                        </div>
                    </div>

                    <!-- ── Descripción adicional (solo cuando subcategoría = 'otro' o categoría = 'otro') ── -->
                    <div x-show="mostrarDescripcion"
                         x-transition:enter="transition ease-out duration-150"
                         x-transition:enter-start="opacity-0 -translate-y-1"
                         x-transition:enter-end="opacity-100 translate-y-0">
                        <label for="descripcion" class="block text-sm font-medium text-gray-700 mb-1">
                            Describe el problema <span class="text-red-500">*</span>
                        </label>
                        <textarea id="descripcion" x-model="form.descripcion"
                                  :required="mostrarDescripcion"
                                  rows="3"
                                  placeholder="Explica con detalle qué ocurre, cuándo ocurre..."
                                  class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none resize-none"
                                  :class="{ 'border-red-400': errores.descripcion }"></textarea>
                        <p x-show="errores.descripcion" x-text="errores.descripcion"
                           class="text-xs text-red-500 mt-1" role="alert"></p>
                    </div>

                    <!-- Vista previa del título que se generará -->
                    <div x-show="tituloPreview"
                         class="bg-blue-50 border border-blue-200 rounded-md px-4 py-3">
                        <p class="text-xs text-blue-600 font-medium mb-1">
                            <i class="fas fa-tag mr-1"></i>El ticket se registrará como:
                        </p>
                        <p class="text-sm text-blue-800 font-semibold" x-text="tituloPreview"></p>
                    </div>

                    <!-- Error general -->
                    <div x-show="errorGeneral"
                         class="bg-red-50 border border-red-200 text-red-700 text-sm px-4 py-3 rounded-md"
                         role="alert">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        <span x-text="errorGeneral"></span>
                    </div>

                    <!-- Éxito -->
                    <div x-show="exito"
                         class="bg-green-50 border border-green-200 text-green-700 text-sm px-4 py-3 rounded-md"
                         role="status">
                        <i class="fas fa-check-circle mr-2"></i>
                        Tu ticket fue creado correctamente. Redirigiendo...
                    </div>

                </div>

                <!-- Footer -->
                <div class="px-6 py-4 bg-gray-50 rounded-b-lg flex justify-end gap-3 flex-shrink-0 border-t border-gray-100">
                    <button type="button" @click="cerrarModal()"
                            class="bg-white hover:bg-gray-100 text-gray-700 border border-gray-300 px-4 py-2 rounded-md text-sm font-medium transition">
                        Cancelar
                    </button>
                    <button type="submit"
                            :disabled="cargando || !formularioValido"
                            class="bg-blue-600 hover:bg-blue-700 disabled:bg-blue-300 disabled:cursor-not-allowed text-white px-5 py-2 rounded-md text-sm font-medium transition inline-flex items-center gap-2">
                        <svg x-show="cargando" class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                        </svg>
                        <span x-text="cargando ? 'Enviando...' : 'Crear Ticket'"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
// Datos del empleado inyectados desde Django
const EQUIPOS_EMPLEADO = {{ equipos_empleado_json|safe }};
const NOMBRE_EMPLEADO = "{{ request.user.get_full_name|default:request.user.username }}";

function listaTickets() {
    return {
        modalNuevo: false,
        cargando: false,
        exito: false,
        errorGeneral: '',
        errores: {},

        // Datos de catálogos
        equiposEmpleado: EQUIPOS_EMPLEADO,

        categorias: [
            { valor: 'hardware', label: 'Hardware',         icono: 'fas fa-microchip' },
            { valor: 'software', label: 'Software',         icono: 'fas fa-code' },
            { valor: 'red',      label: 'Red / Internet',   icono: 'fas fa-network-wired' },
            { valor: 'otro',     label: 'Otro',             icono: 'fas fa-question-circle' },
        ],

        subcategoriasSoftware: [
            { valor: 'windows',       label: 'Windows',        icono: 'fab fa-windows' },
            { valor: 'office',        label: 'Office',         icono: 'fas fa-file-word' },
            { valor: 'sistemas_casa', label: 'Sistemas Casa',  icono: 'fas fa-building' },
            { valor: 'otro',          label: 'Otro',           icono: 'fas fa-ellipsis-h' },
        ],

        subcategoriasRed: [
            { valor: 'no_abre_pagina',      label: 'No abre una página específica', icono: 'fas fa-globe' },
            { valor: 'sin_internet_todos',  label: 'Sin internet en todos los equipos', icono: 'fas fa-wifi' },
            { valor: 'sin_internet_mi_equipo', label: 'Sin internet en mi equipo',   icono: 'fas fa-desktop' },
            { valor: 'no_imprime',          label: 'No puedo imprimir',              icono: 'fas fa-print' },
            { valor: 'otro',                label: 'Otro',                           icono: 'fas fa-ellipsis-h' },
        ],

        form: {
            categoria: '',
            subcategoria: '',
            descripcion: '',
            equipoId: null,
        },

        // Computed: mostrar campo de descripción
        get mostrarDescripcion() {
            return this.form.categoria === 'otro' ||
                   this.form.subcategoria === 'otro';
        },

        // Computed: validez mínima del formulario
        get formularioValido() {
            if (!this.form.categoria) return false;
            if (this.form.categoria === 'hardware') {
                // Si no hay equipos en inventario, permitir envío sin selección
                if (this.equiposEmpleado.length === 0) return true;
                return !!this.form.subcategoria;
            }
            if (this.form.categoria === 'software' || this.form.categoria === 'red') {
                if (!this.form.subcategoria) return false;
                if (this.form.subcategoria === 'otro') return this.form.descripcion.trim().length >= 5;
                return true;
            }
            if (this.form.categoria === 'otro') {
                return this.form.descripcion.trim().length >= 5;
            }
            return true;
        },

        // Computed: preview del título a generar
        get tituloPreview() {
            if (!this.form.categoria) return '';

            const catLabels = {
                hardware: 'Hardware', software: 'Software',
                red: 'Red / Conectividad', otro: 'Otro',
            };
            const subLabelsSoftware = {
                windows: 'Windows', office: 'Office',
                sistemas_casa: 'Sistemas Casa', otro: 'Otro',
            };
            const subLabelsRed = {
                no_abre_pagina: 'No abre página',
                sin_internet_todos: 'Sin internet en todos',
                sin_internet_mi_equipo: 'Sin internet en mi equipo',
                no_imprime: 'No puedo imprimir',
                otro: 'Otro',
            };

            const catLabel = catLabels[this.form.categoria] || this.form.categoria;
            let subLabel = '';

            if (this.form.categoria === 'hardware' && this.form.subcategoria) {
                if (this.form.subcategoria === 'telefono') {
                    subLabel = 'Teléfono IP';
                } else {
                    const eq = this.equiposEmpleado.find(e => 'eq_' + e.id === this.form.subcategoria);
                    subLabel = eq ? eq.marca + ' ' + eq.modelo : '';
                }
            } else if (this.form.categoria === 'software') {
                subLabel = subLabelsSoftware[this.form.subcategoria] || '';
            } else if (this.form.categoria === 'red') {
                subLabel = subLabelsRed[this.form.subcategoria] || '';
            }

            return subLabel
                ? `${NOMBRE_EMPLEADO} - ${catLabel}: ${subLabel}`
                : `${NOMBRE_EMPLEADO} - ${catLabel}`;
        },

        init() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('nuevo') === '1') this.modalNuevo = true;
        },

        seleccionarCategoria(valor) {
            if (this.form.categoria !== valor) {
                this.form.subcategoria = '';
                this.form.descripcion = '';
                this.form.equipoId = null;
                this.errores = {};
            }
            this.form.categoria = valor;
        },

        cerrarModal() {
            if (this.exito) return;
            this.modalNuevo = false;
            this.resetForm();
        },

        resetForm() {
            this.form = { categoria: '', subcategoria: '', descripcion: '', equipoId: null };
            this.errores = {};
            this.errorGeneral = '';
            this.exito = false;
        },

        async submitTicket() {
            this.cargando = true;
            this.errores = {};
            this.errorGeneral = '';

            const csrfToken = this.getCookie('csrftoken');

            // Resolver subcategoría real para hardware con FK de equipo
            let subcategoriaEnviar = this.form.subcategoria;
            let equipoId = null;

            if (this.form.categoria === 'hardware') {
                if (this.form.subcategoria === 'telefono') {
                    subcategoriaEnviar = 'telefono';
                } else if (this.form.subcategoria.startsWith('eq_')) {
                    equipoId = parseInt(this.form.subcategoria.replace('eq_', ''));
                    subcategoriaEnviar = 'computadora';
                }
            }

            const payload = {
                categoria:     this.form.categoria,
                subcategoria:  subcategoriaEnviar,
                descripcion:   this.form.descripcion || '',
            };
            if (equipoId) payload.equipo = equipoId;

            try {
                const resp = await fetch('/api/it/tickets/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                    },
                    body: JSON.stringify(payload),
                });

                const data = await resp.json();

                if (resp.ok) {
                    this.exito = true;
                    setTimeout(() => {
                        window.location.href = '/it/tickets/' + data.id + '/';
                    }, 1200);
                } else {
                    if (typeof data === 'object') {
                        if (data.descripcion)  this.errores.descripcion  = Array.isArray(data.descripcion)  ? data.descripcion[0]  : data.descripcion;
                        if (data.categoria)    this.errores.categoria    = Array.isArray(data.categoria)    ? data.categoria[0]    : data.categoria;
                        if (data.subcategoria) this.errores.subcategoria = Array.isArray(data.subcategoria) ? data.subcategoria[0] : data.subcategoria;
                        if (data.non_field_errors) {
                            this.errorGeneral = Array.isArray(data.non_field_errors) ? data.non_field_errors[0] : data.non_field_errors;
                        } else if (data.detail) {
                            this.errorGeneral = data.detail;
                        }
                    } else {
                        this.errorGeneral = 'Ocurrió un error. Intenta de nuevo.';
                    }
                }
            } catch (e) {
                this.errorGeneral = 'Error de conexión. Verifica tu red e intenta de nuevo.';
            } finally {
                this.cargando = false;
            }
        },

        getCookie(name) {
            const match = document.cookie.split(';')
                .map(c => c.trim())
                .find(c => c.startsWith(name + '='));
            return match ? decodeURIComponent(match.split('=')[1]) : null;
        },
    };
}
</script>
{% endblock %}
